---
title: Web3ç³»åˆ—æ•™ç¨‹ä¹‹é«˜çº§ç¯‡---1ï¼šé»˜å…‹å°”æ ‘
description: null
author: æŽç•™ç™½
weight: 0
date: 2022-07-31T13:20:08.487Z
lastmod: 2022-07-31T13:35:52.302Z
tags: []
categories:
  - åŒºå—é“¾
  - WEB3.0
featuredImage: https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/R3RYera.png
---

é»˜å…‹å°”æ ‘æ˜¯åŒºå—é“¾æŠ€æœ¯çš„ä¸€ä¸ªåŸºæœ¬æ¦‚å¿µã€‚å®ƒä»¬æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒè¿›åˆ¶æ ‘ï¼Œç”¨äºŽç¼–ç å¤§å—çš„ä¿¡æ¯ã€‚é»˜å…‹å°”æ ‘çš„é…·ä¹‹å¤„åœ¨äºŽï¼Œå®ƒä»¬æ˜¯ä¸€ç§è‡ªä¸‹è€Œä¸Šçš„ "å»ºç«‹"ï¼Œå¹¶å…è®¸ä½ éªŒè¯æŸäº›å€¼æ˜¯å¦å­˜åœ¨äºŽæ ‘ä¸­ï¼Œè€Œä¸éœ€è¦åœ¨æ ‘çš„æ¯ä¸ªå…ƒç´ ä¸Šå¾ªçŽ¯ã€‚æ­£å¦‚æˆ‘ä»¬ä¼šçœ‹åˆ°çš„ï¼Œè¿™å¯èƒ½éžå¸¸æœ‰ç”¨ã€‚ðŸ§

## ä»€ä¹ˆæ˜¯é»˜å…‹å°”æ ‘ï¼Ÿ

é»˜å…‹å°”æ ‘æ˜¯ä¸€ç§å“ˆå¸Œæ ‘ï¼Œå…¶ä¸­æ¯ä¸ªå¶å­èŠ‚ç‚¹éƒ½æ ‡æœ‰æ•°æ®å—çš„åŠ å¯†å“ˆå¸Œå€¼ï¼Œè€Œæ¯ä¸ªéžå¶å­èŠ‚ç‚¹éƒ½æ ‡æœ‰å…¶å­èŠ‚ç‚¹çš„åŠ å¯†å“ˆå¸Œå€¼çš„æ ‡ç­¾ã€‚å¤§å¤šæ•°å“ˆå¸Œæ ‘çš„å®žçŽ°æ˜¯äºŒè¿›åˆ¶çš„ï¼ˆæ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼‰ï¼Œä½†å®ƒä»¬ä¹Ÿå¯ä»¥æœ‰æ›´å¤šçš„å­èŠ‚ç‚¹ã€‚

ä¸€ä¸ªå…¸åž‹çš„é»˜å…‹å°”æ ‘çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ã€‚

![](https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/20220731212643.png)

(å¼•ç”¨è‡ª [using-merkle-trees-for-nft-whitelists](https://medium.com/@ItsCuzzo/using-merkle-trees-for-nft-whitelists-523b58ada3f9))

è®©æˆ‘è§£é‡Šä¸€ä¸‹å‘ç”Ÿäº†ä»€ä¹ˆã€‚æ ‘çš„æ‰€æœ‰å¶èŠ‚ç‚¹ï¼Œå³æ²¡æœ‰ä»»ä½•å…¶ä»–å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œéƒ½åŒ…å«æ‚¨è¦ç¼–ç çš„æ•°æ®çš„å“ˆå¸Œå€¼ã€‚è¯·æ³¨æ„ï¼Œæ‚¨è¦åœ¨æ ‘ä¸­ç¼–ç çš„å€¼å§‹ç»ˆåªæ˜¯å¶èŠ‚ç‚¹çš„ä¸€éƒ¨åˆ†ã€‚ç”±äºŽå®ƒæ˜¯äºŒå‰æ ‘ï¼Œæ¯ä¸ªéžå¶èŠ‚ç‚¹éƒ½æœ‰ä¸¤ä¸ªå­©å­ã€‚å½“æ‚¨ä»Žå¶èŠ‚ç‚¹å‘ä¸Šç§»åŠ¨æ—¶ï¼Œçˆ¶èŠ‚ç‚¹å°†æ‹¥æœ‰å¶èŠ‚ç‚¹ç»„åˆå“ˆå¸Œçš„å“ˆå¸Œï¼Œä¾æ­¤ç±»æŽ¨ã€‚

å½“æ‚¨ç»§ç»­è¿™æ ·åšæ—¶ï¼Œæœ€ç»ˆæ‚¨å°†åˆ°è¾¾å•ä¸ªé¡¶çº§èŠ‚ç‚¹ï¼Œç§°ä¸º Merkle æ ‘æ ¹ï¼Œè¿™å°†å‘æŒ¥éžå¸¸é‡è¦çš„ä½œç”¨ã€‚

## ç®€å•ç¤ºä¾‹

å‡è®¾æˆ‘ä»¬æœ‰ 4 ä¸ªäº‹åŠ¡ï¼šâ€œäº‹åŠ¡ Aâ€ã€Bã€C å’Œ Dã€‚å®ƒä»¬éƒ½åœ¨åŒä¸€ä¸ªå—ä¸­æ‰§è¡Œã€‚è¿™äº›äº¤æ˜“ä¸­çš„æ¯ä¸€ä¸ªéƒ½å°†è¢«æ•£åˆ—ã€‚è®©æˆ‘ä»¬åˆ†åˆ«ç§°è¿™äº›å“ˆå¸Œä¸ºâ€œå“ˆå¸Œ Aâ€ã€Bã€C å’Œ Dã€‚

ä»¥ä¸‹æ˜¯è¿™äº›äº¤æ˜“çš„ Merkle Treeï¼š

![](https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/20220731212936.png)

## ä½¿ç”¨ Merkle Root éªŒè¯æœ‰æ•ˆæ€§

å½“è¿™äº›äº¤æ˜“æ±‡æ€»åˆ°ä¸€ä¸ªå—ä¸­æ—¶ï¼Œå—å¤´å°†åŒ…å« Merkle Rootï¼ŒHash ABCDã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰€æœ‰çŸ¿å·¥éƒ½æ‹¥æœ‰æ‰€æœ‰äº¤æ˜“çš„å‰¯æœ¬ï¼Œå› æ­¤æ‹¥æœ‰æ‰€æœ‰äº¤æ˜“å“ˆå¸Œã€‚ä»»ä½•çŸ¿å·¥éƒ½å¯ä»¥æŒ‰éœ€é‡å»º Merkle æ ‘ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªçŸ¿å·¥éƒ½å¯ä»¥é’ˆå¯¹åŒä¸€ç»„äº¤æ˜“ç‹¬ç«‹åˆ°è¾¾åŒä¸€ä¸ª Merkle æ ¹ã€‚

è¿™å…è®¸ä»»ä½•çŸ¿å·¥éªŒè¯æ¬ºè¯ˆäº¤æ˜“ã€‚å‡è®¾æœ‰äººè¯•å›¾å¼•å…¥è™šå‡äº¤æ˜“è€Œä¸æ˜¯äº¤æ˜“ Dã€‚è®©æˆ‘ä»¬å°†æ­¤ç§°ä¸ºäº¤æ˜“ Eã€‚å› ä¸ºæ­¤äº¤æ˜“ä¸Žäº¤æ˜“ D ä¸åŒï¼Œæ‰€ä»¥å“ˆå¸Œä¹Ÿä¼šä¸åŒã€‚Transaction Eçš„Hashå°±æ˜¯Hash Eã€‚Cå’ŒEçš„HashåŠ åœ¨ä¸€èµ·å°±æ˜¯Hash CEï¼Œä¸ŽHash CDä¸åŒã€‚å½“å“ˆå¸Œ AB å’Œ CE ä¸€èµ·å“ˆå¸Œæ—¶ï¼Œä½ å¾—åˆ°å“ˆå¸Œ ABCEã€‚ç”±äºŽå“ˆå¸Œ ABCE ä¸Žå“ˆå¸Œ ABCD ä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºäº¤æ˜“ E æ˜¯æ¬ºè¯ˆæ€§çš„ç»“è®ºã€‚

![](https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/20220731213049.png)

çŸ¿å·¥å¯ä»¥åœ¨è‡ªå·±çš„åŒºå—ä¸­é‡æ–°è®¡ç®— Merkle Root å¹¶å°è¯•å°†è¯¥ç‰ˆæœ¬å‘å¸ƒåˆ°åŒºå—é“¾ï¼Œä½†ç”±äºŽæ¯ä¸ªå…¶ä»–çŸ¿å·¥éƒ½æœ‰ä¸åŒçš„ Merkle Rootï¼Œå› æ­¤æ¬ºè¯ˆçŸ¿å·¥å¾ˆå®¹æ˜“è¢«æ‹’ç»ã€‚

## å“ˆå¸Œå‡½æ•°

åœ¨è°ˆè®º IPFS æ—¶ï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»ä»‹ç»è¿‡å“ˆå¸Œå‡½æ•°ï¼Œä½†åªæ˜¯å›žé¡¾ä¸€ä¸‹ï¼šå°†äº‹åŠ¡ A å“ˆå¸Œåˆ°å“ˆå¸Œ A ä¸­ï¼Œä½¿ç”¨äº†å•å‘åŠ å¯†å“ˆå¸Œå‡½æ•°ã€‚ä¸€æ—¦æ•£åˆ—ï¼ŒHash A å°±ä¸èƒ½å˜æˆ Transaction Aï¼›å“ˆå¸Œæ˜¯ä¸å¯é€†çš„ã€‚

æ¯ä¸ªåŒºå—é“¾ä½¿ç”¨ä¸åŒçš„å“ˆå¸Œå‡½æ•°ï¼Œä½†å®ƒä»¬éƒ½å…·æœ‰ç›¸åŒçš„å…±åŒå±žæ€§ã€‚

#### ç¡®å®šæ€§

å½“ä¼ é€’ç»™æ•£åˆ—å‡½æ•°æ—¶ï¼Œç›¸åŒçš„è¾“å…¥æ€»æ˜¯å…·æœ‰ç›¸åŒçš„è¾“å‡ºã€‚

#### è®¡ç®—æ•ˆçŽ‡é«˜

è®¡ç®—è¾“å…¥å€¼çš„å“ˆå¸Œå€¼å¾ˆå¿«ã€‚

#### æ— æ³•é€†å‘å·¥ç¨‹

ç»™å®šä¸€ä¸ªç»“æžœå“ˆå¸Œï¼Œå‡ ä¹Žä¸å¯èƒ½ç¡®å®šè¾“å…¥ã€‚å³æ•£åˆ—å‡½æ•°æ˜¯å•å‘å‡½æ•°ã€‚ä¾‹å¦‚ï¼šç»™å®š`y`ï¼Œå¾ˆéš¾æ‰¾åˆ°`x`è¿™æ ·çš„`h(x) = y`

#### é˜²æ’ž

ä¸¤ä¸ªä¸åŒçš„è¾“å…¥æ°¸è¿œä¸ä¼šäº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚

## åŒºå—é“¾ä¸­é»˜å…‹å°”æ ‘çš„å¥½å¤„

Merkle Trees å…è®¸å¿«é€ŸéªŒè¯æ•°æ®å®Œæ•´æ€§ã€‚

ä¸Žæ•´ä¸ªäº‹åŠ¡é›†ç›¸æ¯”ï¼Œå·²ç”¨å®Œçš„ç£ç›˜ç©ºé—´éžå¸¸å°‘ã€‚å‡ºäºŽè¿™ä¸ªåŽŸå› ï¼ŒMerkle Root åŒ…å«åœ¨å—å¤´ä¸­ã€‚

å¦‚æžœä½ æœ‰ä¸¤ç»„ä¸åŒçš„äº¤æ˜“ï¼Œç”¨é»˜å…‹å°”æ ‘éªŒè¯å®ƒä»¬æ˜¯å¦ç›¸åŒæ¯”éªŒè¯æ¯ä¸€ä¸ªå•ç‹¬çš„äº¤æ˜“è¦å¿«ã€‚åªéœ€çŸ¥é“ Merkle Rootï¼Œå°±å¯ä»¥éªŒè¯ä¸€ä¸ªå—æ²¡æœ‰è¢«ä¿®æ”¹ã€‚

## åŒºå—é“¾ä¹‹å¤–çš„ç”¨ä¾‹

Merkle æ ‘ä¸ä»…ç”¨äºŽåŒºå—é“¾åº”ç”¨ç¨‹åºã€‚ä¸€äº›ä½¿ç”¨ Merkle æ ‘çš„æµè¡Œåº”ç”¨ç¨‹åºæ˜¯ï¼š

- [IPFS](https://en.wikipedia.org/wiki/InterPlanetary_File_System)
- [Github](https://github.com/)
- [AWS DynamoDB](https://aws.amazon.com/dynamodb)å’Œ[Apache Cassandra](https://cassandra.apache.org/_/index.html)ç­‰åˆ†å¸ƒå¼æ•°æ®åº“ä½¿ç”¨ Merkle æ ‘æ¥æŽ§åˆ¶å·®å¼‚

## éªŒè¯ Merkle æ ‘ä¸­çš„å­˜åœ¨

é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•çœŸæ­£éªŒè¯æŸäº›æ•°æ®æ˜¯é»˜å…‹å°”æ ‘çš„ä¸€éƒ¨åˆ†å‘¢ï¼Ÿ

æ‚¨ä¸å¸Œæœ›éªŒè¯å™¨éåŽ† Merkle æ ‘çš„æ¯ä¸ªå¶èŠ‚ç‚¹ï¼Œå› ä¸ºå®ƒå¯èƒ½éžå¸¸å¤§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä»¥æ›´æœ‰æ•ˆçš„æ–¹å¼åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ

å‡è®¾`Verifier`å”¯ä¸€æœ‰`Merkle Root` `r`ï¼Œå³æ ‘çš„é¡¶çº§çˆ¶èŠ‚ç‚¹ã€‚ä½ ï¼Œä½œä¸ºä¸€ä¸ª`Prover`ï¼Œæƒ³è¦è¯æ˜Žé»˜å…‹å°”æ ‘ä¸­å­˜åœ¨`Verifier`ä¸€äº›ä»·å€¼ã€‚`K`

ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥ç”Ÿæˆä¸€ä¸ª`Merkle Proof`. `Merkle Proof`è®©æˆ‘ä»¬å°è¯•é€šè¿‡ç¤ºä¾‹ Merkle æ ‘æ¥äº†è§£ a çš„å®žé™…å«ä¹‰ã€‚

![](https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/20220731213210.png)

ï¼ˆå‚è€ƒ[é»˜å…‹å°”è¯æ˜Žè§£é‡Š](https://medium.com/crypto-0-nite/merkle-proofs-explained-6dd429623dc5)ï¼‰

ä¸»è¦æ€æƒ³å¦‚ä¸‹ï¼šå¦‚æžœæ‚¨å¯ä»¥ç»™å‡º çš„`Verifier`å€¼`K`ï¼Œä»¥åŠæ ‘ä¸­çš„æ‰€æœ‰ç›¸å…³èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹è¢«æ•£åˆ—åœ¨ä¸€èµ·ä»¥æž„å»º`r`æ•£åˆ—ï¼Œåˆ™`Verifier`å¯ä»¥å°†è®¡ç®—çš„æ ¹å€¼ä¸Ž`r`å®ƒä»¬å·²ç»æ‹¥æœ‰çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æžœå®ƒä»¬æ˜¯ç›¸åŒçš„æ•£åˆ—ï¼Œé‚£ä¸€å®šæ„å‘³ç€å®ƒ`K`å®žé™…ä¸Šå­˜åœ¨äºŽ Merkle æ ‘ä¸­ï¼Œå› ä¸ºæ‚¨ä¸å¯èƒ½ä½¿ç”¨ä¸åŒçš„è¾“å…¥æ•°æ®ç”Ÿæˆç›¸åŒçš„ Merkle Root æ•£åˆ—ã€‚

åœ¨ä¸Šå›¾ä¸­ï¼Œè®©æˆ‘ä»¬è€ƒè™‘å¿…é¡»å‘éªŒè¯è€…æä¾›å“ªäº›ä¿¡æ¯ï¼Œæ‰èƒ½ç§¯æžåœ°å‘`K`ä½œä¸ºé»˜å…‹å°”æ ‘ä¸€éƒ¨åˆ†çš„éªŒè¯è€…è¯æ˜Žã€‚

- è‡ªèº«çš„ä»·å€¼`K`ï¼ˆå› æ­¤éªŒè¯è€…å¯ä»¥`H(K)`è‡ªå·±è®¡ç®—ï¼‰
- `H(L)`ï¼Œå› æ­¤éªŒè¯è€…å¯ä»¥è®¡ç®—`H(KL)`
- `H(IJ)`æ‰€ä»¥éªŒè¯è€…å¯ä»¥è®¡ç®—`H(IJKL)`
- `H(MNOP)`æ‰€ä»¥éªŒè¯è€…å¯ä»¥è®¡ç®—`H(IJKLMNOP)`
- `H(ABCDEFGH)`æ‰€ä»¥éªŒè¯è€…å¯ä»¥è®¡ç®—`H(ABCDEFGHIJKLMNOP)`

å†æ¬¡é‡è¦çš„æ˜¯è¦è®°ä½ï¼Œåªæœ‰ä¸€ä¸ªç»™å®šçš„èŠ‚ç‚¹ç»„åˆå¯ä»¥ç”Ÿæˆè¿™ä¸ªå”¯ä¸€çš„æ ¹`r`ï¼Œå› ä¸º Merkle æ ‘æ˜¯ä¸€ä¸ª `collision-resistant hash function`ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œç»™å®šä¸¤ä¸ªè¾“å…¥å‡ ä¹Žä¸å¯èƒ½äº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚

å¯¹äºŽæˆ‘ä»¬ç»™å®šçš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬åªéœ€è¦æä¾›ä»¥ä¸‹èŠ‚ç‚¹å³å¯è¯æ˜Ž H[K] ç¡®å®žå­˜åœ¨äºŽæˆ‘ä»¬çš„èŠ‚ç‚¹ä¸­ï¼š

![](https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/20220731213233.png)

æ­¤æ—¶ï¼Œå¦‚æžœ çš„è®¡ç®—å€¼ä¸Ž Verifier`H(ABCDEFGHIJKLMNOP)`å…ˆå‰å·²çŸ¥çš„å€¼åŒ¹é…`r`ï¼Œåˆ™åœ¨ Merkle Tree ä¸­å­˜åœ¨ä¸€å®šä¸ºçœŸï¼Œ`K`å¦åˆ™å“ˆå¸Œå€¼å°†ä¸ä¸€æ ·ã€‚

è¿™*æ¯”*éåŽ†æ•´ä¸ª Merkle æ ‘è¦é«˜æ•ˆå¾—å¤šï¼Œå› ä¸ºå¯¹äºŽå…·æœ‰`n`å¤šä¸ªå…ƒç´ çš„æ ‘ï¼Œæ‚¨åªéœ€æä¾›ç²—ç•¥`log(n)`çš„å…ƒç´ ä½œä¸ºè¯æ˜Žçš„ä¸€éƒ¨åˆ†ï¼ˆæ ‘çš„æ¯ä¸ªâ€œçº§åˆ«â€ä¸€ä¸ªï¼‰ã€‚è¿™æ„å‘³ç€å¦‚æžœæ‚¨æœ‰å¤§é‡æ•°æ®ï¼ŒMerkle æ ‘æ¯”å­˜å‚¨æ•°ç»„æˆ–æ˜ å°„æ›´æœ‰æ•ˆã€‚

> å½“ ENS å¯åŠ¨ä»–ä»¬çš„ä»£å¸åˆçº¦æ—¶ï¼Œä»–ä»¬å°† $ENS ä»£å¸ç©ºæŠ•åˆ°è¶…è¿‡ 100,000 ä¸ªé’±åŒ…åœ°å€ã€‚ä»–ä»¬èƒ½å¤Ÿåœ¨æ±½æ²¹è´¹æžé«˜çš„æƒ…å†µä¸‹ä»¥æ¯”å°†é’±åŒ…åœ°å€å­˜å‚¨åœ¨æ•°ç»„ä¸­çš„ä»·æ ¼ä½Žå¾—å¤šçš„ä»·æ ¼éƒ¨ç½²ä»–ä»¬çš„åˆçº¦ï¼ˆå³ä½¿å­˜å‚¨å‡ ç™¾ä¸ªåœ°å€ä¹Ÿå¾ˆå®¹æ˜“è¶…è¿‡æ±½æ²¹è´¹ï¼‰å—çš„é™åˆ¶ï¼‰ - https://etherscan.io/tx/0xdfc76788b13ab1c033c7cd55fdb7a431b2bc8abe6b19ac9f7d22f4105bb43bff

## æ™ºèƒ½åˆçº¦ä¸­çš„ç”¨ä¾‹

ç”±äºŽéªŒè¯è€…ä¸éœ€è¦å­˜å‚¨æ•´ä¸ª Merkle Tree æ¥éªŒè¯æ˜¯å¦æ˜¯å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼ŒMerkle Trees å®žé™…ä¸Šå¯¹äºŽæŸäº›äº‹æƒ…éžå¸¸æ–¹ä¾¿ã€‚

åœ¨å¤§äºŒï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå°†ç”¨æˆ·åœ°å€å­˜å‚¨åœ¨æ˜ å°„ä¸­çš„ç™½åå• dAppã€‚è™½ç„¶è¿™ç§æ–¹æ³•æœ‰æ•ˆï¼Œä½†åœ¨æ™ºèƒ½åˆçº¦å­˜å‚¨ä¸­å­˜å‚¨æ•°æ®æ˜¯è¿„ä»Šä¸ºæ­¢ä½ å¯ä»¥åšçš„æœ€æ˜‚è´µçš„äº‹æƒ…ï¼Œå°± gas è€Œè¨€ã€‚é‚£ä¹ˆå¦‚æžœä½ å¿…é¡»å­˜å‚¨ 1000 ä¸ªåœ°å€å‘¢ï¼Ÿå¦‚æžœæ˜¯ä¸€ä¸‡å‘¢ï¼Ÿ10ä¸‡å‘¢ï¼ŸðŸ¤¯

åˆ°é‚£æ—¶ï¼Œç›´æŽ¥ä½¿ç”¨æ™ºèƒ½åˆçº¦å­˜å‚¨æ˜¯ä¸å¯è¡Œçš„ï¼Œä»…ä»…å°†äººä»¬åˆ—å…¥ç™½åå•å°±å¾ˆå®¹æ˜“èŠ±è´¹æ•°ç™¾ä¸‡ç¾Žå…ƒã€‚å¦ä¸€æ–¹é¢ï¼Œä½ å¯ä»¥å»ºç«‹ä¸€ä¸ªé»˜å…‹å°”æ ‘ï¼Œç„¶åŽå°†é»˜å…‹å°”æ ¹å€¼å­˜å‚¨åœ¨åˆçº¦ä¸­â€”â€”ä¸€ä¸ªå¾®ä¸è¶³é“çš„`bytes32`å€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆçº¦çŽ°åœ¨æ˜¯`Verifier`ï¼Œå¹¶ä¸”å¸Œæœ›ä½¿ç”¨ä»–ä»¬çš„ç™½åå•æ¥é“¸é€  NFT çš„ç”¨æˆ·ï¼Œæ¯”æ–¹è¯´ï¼Œæˆä¸º`Provers`ä»–ä»¬ç¡®å®žæ˜¯ç™½åå•çš„ä¸€éƒ¨åˆ†çš„è¯æ˜Žã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

## å»ºé€ 

### å…ˆå†³æ¡ä»¶

- å¦‚æžœæ‚¨ä¸äº†è§£ Mocha å’Œ Chaiï¼Œè¯·å­¦ä¹ å®ƒä»¬çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥äº†è§£å®ƒä»¬æ˜¯ä»€ä¹ˆï¼Œè¯·éµå¾ªæœ¬[æ•™ç¨‹](https://medium.com/spidernitt/testing-with-mocha-and-chai-b8da8d2e10f2)

è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸€åˆ‡åœ¨æˆ‘ä»¬çš„ç™½åå•ç¤ºä¾‹ä¸­æ˜¯å¦‚ä½•å®žé™…å·¥ä½œçš„ã€‚

- è¦è®¾ç½® Hardhat é¡¹ç›®ï¼Œè¯·æ‰“å¼€ç»ˆç«¯å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```bash
  npm init --yes
  npm install --save-dev hardhat
```

- å¦‚æžœæ‚¨åœ¨ Windows æœºå™¨ä¸Šï¼Œè¯·æ‰§è¡Œæ­¤é¢å¤–æ­¥éª¤å¹¶å®‰è£…è¿™äº›åº“ï¼š)

```bash
npm install --save-dev @nomiclabs/hardhat-waffle ethereum-waffle chai @nomiclabs/hardhat-ethers ethers

```

- åœ¨å®‰è£… Hardhat çš„åŒä¸€ç›®å½•ä¸­è¿è¡Œï¼š

```bash
npx hardhat
```

- é€‰æ‹©`Create a basic sample project`
- æŒ‰å›žè½¦é”®å·²æŒ‡å®š`Hardhat Project root`
- å¦‚æžœæ‚¨æƒ³æ·»åŠ ä¸€ä¸ªé—®é¢˜ï¼Œè¯·æŒ‰ Enter é”®`.gitignore`
- æŒ‰å›žè½¦é”®`Do you want to install this sample project's dependencies with npm (@nomiclabs/hardhat-waffle ethereum-waffle chai @nomiclabs/hardhat-ethers ethers)?`

çŽ°åœ¨æ‚¨çš„Hardhatæ–‡ä»¶å¤¹å·²è®¾ç½®å®Œæ¯•ã€‚

æˆ‘ä»¬è¿˜éœ€è¦å®‰è£…ä¸€äº›é¢å¤–çš„ä¾èµ–é¡¹æ¥æ‰§è¡Œä¸€åˆ‡ã€‚å› æ­¤ï¼Œå†æ¬¡åœ¨æŒ‡å‘æ ¹ç›®å½•çš„ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
npm install @openzeppelin/contracts keccak256 merkletreejs
```

`contracts`çŽ°åœ¨é¦–å…ˆåœ¨æ‚¨çš„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºçš„æ–‡ä»¶`Whitelist.sol`å¹¶å°†ä»¥ä¸‹ä»£ç è¡Œæ·»åŠ åˆ°å…¶ä¸­

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

import "@openzeppelin/contracts/utils/cryptography/MerkleProof.sol";

contract Whitelist {

    bytes32 public merkleRoot;

    constructor(bytes32 _merkleRoot) {
        merkleRoot = _merkleRoot;
    }

    function checkInWhitelist(bytes32[] calldata proof, uint64 maxAllowanceToMint) view public returns (bool) {
        bytes32 leaf = keccak256(abi.encode(msg.sender, maxAllowanceToMint));
        bool verified = MerkleProof.verify(proof, merkleRoot, leaf);
        return verified;
    }
    
}
```

è¿™é‡Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿå› æ­¤ï¼Œæ­£å¦‚æˆ‘ä»¬æåˆ°çš„ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨åˆçº¦ä¸­å­˜å‚¨æ¯ä¸ªç”¨æˆ·çš„åœ°å€ï¼Œè€Œæ˜¯åªå­˜å‚¨åœ¨æž„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çš„é»˜å…‹å°”æ ‘çš„æ ¹ã€‚

æˆ‘ä»¬è¿˜æœ‰å¦ä¸€ä¸ªå‡½æ•°`checkInWhitelist`ï¼Œå®ƒæŽ¥å— a`proof`å’Œ`maxAllowanceToMint`ã€‚ `maxAllowanceToMint`æ˜¯ä¸€ä¸ªå˜é‡ï¼Œç”¨äºŽè·Ÿè¸ªç»™å®šåœ°å€å¯ä»¥é“¸é€ çš„ NFT æ•°é‡ã€‚

å¯¹äºŽè¿™ä¸ªç”¨ä¾‹ï¼Œæˆ‘ä»¬å®žé™…å­˜å‚¨åœ¨ Merkle æ ‘ä¸­çš„å€¼æ˜¯å­˜å‚¨ç”¨æˆ·çš„åœ°å€ä»¥åŠä»–ä»¬è¢«å…è®¸é“¸é€ çš„ NFT æ•°é‡ã€‚æ‚¨å¯ä»¥åœ¨ Merkle Trees ä¸­å­˜å‚¨æ‚¨æƒ³è¦çš„ä»»ä½•æ•°æ®ï¼Œä½†è¿™é€‚ç”¨äºŽæˆ‘ä»¬çš„ç¤ºä¾‹ã€‚è¯¥åœ°å€æ‰€åœ¨çš„å¶èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å¯ä»¥é€šè¿‡é¦–å…ˆå°†å‘é€è€…çš„åœ°å€å’Œ`maxAllowanceToMint`å­—èŠ‚å­—ç¬¦ä¸²ç¼–ç æ¥è®¡ç®—ï¼Œè¯¥å­—ç¬¦ä¸²è¿›ä¸€æ­¥ä¼ é€’ç»™`keccak256`å“ˆå¸Œå‡½æ•°ï¼Œå“ˆå¸Œå‡½æ•°éœ€è¦å“ˆå¸Œå­—ç¬¦ä¸²æ¥ç”Ÿæˆå“ˆå¸Œå€¼ã€‚

çŽ°åœ¨æˆ‘ä»¬ä½¿ç”¨ OpenZeppelin çš„`MerkleProof`åº“æ¥éªŒè¯ç”¨æˆ·å‘é€çš„è¯æ˜Žç¡®å®žæœ‰æ•ˆã€‚è¯·æ³¨æ„ï¼ŒOpenzeppelin å¦‚ä½•æ‰§è¡Œé«˜çº§åˆ«çš„éªŒè¯ç±»ä¼¼äºŽæˆ‘ä»¬åœ¨æ•™ç¨‹å‰é¢è®¨è®ºçš„ Merkle è¯æ˜Žçš„éªŒè¯ã€‚

æŽ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæµ‹è¯•æ¥å¸®åŠ©ç¡®å®šæˆ‘ä»¬åˆçº¦ä¸­çš„ä»£ç æ˜¯å¦çœŸçš„æœ‰æ•ˆã€‚

åœ¨æ‚¨çš„`test`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶`merkle-root.js`å¹¶å°†ä»¥ä¸‹ä»£ç è¡Œæ·»åŠ åˆ°å…¶ä¸­

```javascript
const { expect } = require("chai");
const { ethers } = require("hardhat");
const keccak256 = require("keccak256");
const { MerkleTree } = require("merkletreejs");

function encodeLeaf(address, spots) {
  // Same as `abi.encodePacked` in Solidity
  return ethers.utils.defaultAbiCoder.encode(
    ["address", "uint64"],
    [address, spots]
  );
}

describe("Check if merkle root is working", function () {
  it("Should be able to verify if a given address is in whitelist or not", async function () {
  
    // Get a bunch of test addresses
    const [owner, addr1, addr2, addr3, addr4, addr5] =
      await ethers.getSigners();
    
    // Create an array of elements you wish to encode in the Merkle Tree
    const list = [
      encodeLeaf(owner.address, 2),
      encodeLeaf(addr1.address, 2),
      encodeLeaf(addr2.address, 2),
      encodeLeaf(addr3.address, 2),
      encodeLeaf(addr4.address, 2),
      encodeLeaf(addr5.address, 2),
    ];

    // Create the Merkle Tree using the hashing algorithm `keccak256`
    // Make sure to sort the tree so that it can be produced deterministically regardless
    // of the order of the input list
    const merkleTree = new MerkleTree(list, keccak256, {
      hashLeaves: true,
      sortPairs: true,
    });
    // Compute the Merkle Root
    const root = merkleTree.getHexRoot();

    // Deploy the Whitelist contract
    const whitelist = await ethers.getContractFactory("Whitelist");
    const Whitelist = await whitelist.deploy(root);
    await Whitelist.deployed();

    // Compute the Merkle Proof of the owner address (0'th item in list)
    // off-chain. The leaf node is the hash of that value.
    const leaf = keccak256(list[0]);
    const proof = merkleTree.getHexProof(leaf);

    // Provide the Merkle Proof to the contract, and ensure that it can verify
    // that this leaf node was indeed part of the Merkle Tree
    let verified = await Whitelist.checkInWhitelist(proof, 2);
    expect(verified).to.equal(true);
    
    // Provide an invalid Merkle Proof to the contract, and ensure that
    // it can verify that this leaf node was NOT part of the Merkle Tree
    verified = await Whitelist.checkInWhitelist([], 2);
    expect(verified).to.equal(false);
  });
});
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆè®©ä¸€äº›ç­¾åè€…ä½¿ç”¨ hardhat çš„æ‰©å±• ethers åŒ…è¿›è¡Œæµ‹è¯•ã€‚

ç„¶åŽæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹åˆ—è¡¨ï¼Œè¿™äº›èŠ‚ç‚¹éƒ½ä½¿ç”¨`ethers.utils.defaultAbiCoder.encode`

ä½¿ç”¨æˆ‘ä»¬è¾“å…¥åˆ—è¡¨ä¸­çš„`MerkleTree`ç±»ï¼ŒæŒ‡å®šæˆ‘ä»¬çš„æ•£åˆ—å‡½æ•°ï¼Œå¹¶å°†èŠ‚ç‚¹çš„æŽ’åºè®¾ç½®ä¸º`merkletreejs``keccak256``true`

åˆ›å»º åŽ`Merkle Tree`ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨`getHexRoot`å‡½æ•°æ¥èŽ·å–å®ƒçš„æ ¹ã€‚æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ ¹æ¥éƒ¨ç½²æˆ‘ä»¬çš„`Whitelist`åˆçº¦ã€‚

åœ¨æˆ‘ä»¬çš„åˆçº¦è¢«éªŒè¯åŽï¼Œæˆ‘ä»¬å¯ä»¥`checkInWhitelist`é€šè¿‡æä¾›è¯æ˜Žæ¥è°ƒç”¨æˆ‘ä»¬çš„åˆçº¦ã€‚æ‰€ä»¥çŽ°åœ¨åœ¨è¿™é‡Œæˆ‘ä»¬å°†æ£€æŸ¥`(owner.address, 2)`æˆ‘ä»¬çš„æ•°æ®é›†ä¸­æ˜¯å¦å­˜åœ¨ã€‚ä¸ºäº†ç”Ÿæˆè¯æ˜Žï¼Œæˆ‘ä»¬å¯¹ çš„ç¼–ç å€¼è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œå¹¶ä½¿ç”¨åº“ä¸­çš„å‡½æ•°`(owner.address, 2)`ç”Ÿæˆè¯æ˜Ž ã€‚`getHexProof``merkletreejs`

ç„¶åŽå°†è¯¥è¯æ˜Ž`checkInWhitelist`ä½œä¸ºå‚æ•°å‘é€ï¼Œè¯¥å‚æ•°è¿›ä¸€æ­¥è¿”å›ž true å€¼ä»¥è¡¨ç¤º`(owner.address, 2)`å­˜åœ¨ã€‚

è¦è¿è¡Œæµ‹è¯•ï¼Œè¯·ä»Žç›®å½•çš„æ ¹ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
npx hardhat test
```

å¦‚æžœä½ æ‰€æœ‰çš„æµ‹è¯•éƒ½é€šè¿‡äº†ï¼Œä½ å°±æˆåŠŸåœ°äº†è§£äº† Merkle æ ‘æ˜¯ä»€ä¹ˆä»¥åŠå®ƒå¦‚ä½•ç”¨äºŽç™½åå• ðŸ¥³ ðŸ¥³ ðŸ¥³

å¸Œæœ›ä½ çŽ©å¾—å¼€å¿ƒï¼ï¼

å¹²æ¯ðŸ¥‚

> åŽŸæ–‡ï¼š[https://www.learnweb3.io/tracks/senior/merkle-trees](https://www.learnweb3.io/tracks/senior/merkle-trees)

![](https://hicoldcat.oss-cn-hangzhou.aliyuncs.com/img/my.png)